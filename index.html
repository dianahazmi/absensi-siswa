<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Siswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 600px; margin-top: 50px; }
    .student-card { padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .thumbnail { max-width: 200px; border-radius: 10px; margin-top: 10px; }
  </style>
</head>
<body>
<div class="container">
  <h3 class="text-center mb-3">ðŸ“· Absensi Siswa</h3>

  <!-- STATUS KONEKSI -->
  <div id="statusKoneksi" class="alert alert-secondary py-2 text-center">ðŸ”„ Mengecek koneksi ke Google Sheet...</div>

  <!-- Search Box -->
  <input class="form-control" list="namaList" id="namaInput" placeholder="Cari nama Anda...">
  <datalist id="namaList"></datalist>
  <button class="btn btn-primary w-100 mt-3" onclick="cariNama()">Pilih Nama</button>

  <!-- Student Section -->
  <div id="studentSection" class="student-card mt-4 d-none"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwKdXRKhuBjRRkc8xNUQHDWB7-M7Kb_T0XQuYe_oNpiMCQCLO5mZnbCdj-t5ypIFcwkdA/exec";
let allStudents = [];
let currentStudent = null;

// === CEK KONEKSI & AMBIL DATA NAMA ===
fetch(SCRIPT_URL)
  .then(res => {
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  })
  .then(data => {
    allStudents = data;
    let list = document.getElementById("namaList");
    data.forEach(s => {
      let opt = document.createElement("option");
      opt.value = s.nama;
      list.appendChild(opt);
    });
    document.getElementById("statusKoneksi").className = "alert alert-success py-2 text-center";
    document.getElementById("statusKoneksi").innerText = "âœ… Tersambung ke Google Sheet (" + data.length + " siswa)";
  })
  .catch(err => {
    document.getElementById("statusKoneksi").className = "alert alert-danger py-2 text-center";
    document.getElementById("statusKoneksi").innerText = "âŒ Gagal koneksi ke Google Sheet: " + err;
  });

// === FUNGSI CARI NAMA ===
function cariNama() {
  const nama = document.getElementById("namaInput").value.trim();
  currentStudent = allStudents.find(s => s.nama.toLowerCase() === nama.toLowerCase());

  const section = document.getElementById("studentSection");
  if (!currentStudent) {
    section.classList.remove("d-none");
    section.innerHTML = `<p class="text-danger">Nama tidak ditemukan.</p>`;
    return;
  }

  if (currentStudent.foto) {
    section.classList.remove("d-none");
    section.innerHTML = `
      <h5>${currentStudent.nama}</h5>
      <p>Status: <span class="badge bg-${currentStudent.status.includes("Terverifikasi") ? "success" : "warning"}">${currentStudent.status}</span></p>
      <a href="${currentStudent.foto}" target="_blank">
        <img src="${currentStudent.foto}" class="thumbnail img-thumbnail">
      </a>
    `;
  } else {
    section.classList.remove("d-none");
    section.innerHTML = `
      <h5>${currentStudent.nama}</h5>
      <p>Status: <span class="badge bg-secondary">Belum Absen</span></p>
      <input type="file" id="fotoInput" accept="image/*" class="form-control mt-2">
      <button class="btn btn-success mt-3" onclick="uploadFoto()">Kirim Foto</button>
    `;
  }
}

// === UPLOAD FOTO ===
function uploadFoto() {
  const fileInput = document.getElementById("fotoInput");
  if (!fileInput.files.length) {
    alert("Pilih foto terlebih dahulu!");
    return;
  }
  const file = fileInput.files[0];
  if (file.size > 1024 * 1024) {
    alert("Ukuran foto maksimal 1MB");
    return;
  }

  const reader = new FileReader();
  reader.onloadend = () => {
    fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify({
        nama: currentStudent.nama,
        foto: reader.result
      }),
      headers: { "Content-Type": "application/json" }
    })
    .then(res => res.text())
    .then(txt => {
      alert("Foto berhasil dikirim! Refresh halaman untuk melihat status.");
    })
    .catch(err => alert("Gagal upload: " + err));
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
