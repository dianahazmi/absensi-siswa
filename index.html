<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Foto Siswa</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; }
    .hidden { display: none; }
    img { max-width: 150px; margin-top: 10px; border-radius: 8px; }
    button { padding: 8px 15px; margin-top: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Absensi Foto Siswa</h2>

  <label>Cari Nama Siswa:</label><br>
  <input type="text" id="searchBox" placeholder="Ketik nama..." />
  <div id="suggestions"></div>

  <div id="formArea" class="hidden">
    <h3 id="selectedName"></h3>
    <div id="statusArea"></div>
    <div id="uploadArea" class="hidden">
      <input type="file" id="fileInput" accept="image/*"><br>
      <button onclick="uploadFoto()">Upload Foto</button>
    </div>
    <div id="previewArea"></div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwKdXRKhuBjRRkc8xNUQHDWB7-M7Kb_T0XQuYe_oNpiMCQCLO5mZnbCdj-t5ypIFcwkdA/exec";
    let allData = [];
    let selectedNama = "";

    // Ambil data dari Google Sheet
    async function loadData() {
      try {
        let res = await fetch(SCRIPT_URL);
        let json = await res.json();
        if (json.status === "success") {
          allData = json.data;
        } else {
          alert("❌ Gagal ambil data: " + json.message);
        }
      } catch (err) {
        alert("❌ Error koneksi: " + err.message);
      }
    }

    // Autocomplete pencarian
    document.getElementById("searchBox").addEventListener("input", function () {
      let keyword = this.value.toLowerCase();
      let matches = allData.filter(s => s.nama.toLowerCase().includes(keyword));
      let html = matches.map(m => `<div onclick="selectNama('${m.nama}')">${m.nama}</div>`).join("");
      document.getElementById("suggestions").innerHTML = html;
    });

    // Saat nama dipilih
    function selectNama(nama) {
      selectedNama = nama;
      let siswa = allData.find(s => s.nama === nama);
      document.getElementById("suggestions").innerHTML = "";
      document.getElementById("formArea").classList.remove("hidden");
      document.getElementById("selectedName").innerText = "Nama: " + nama;
      updateStatus(siswa);
    }

    // Update tampilan status & upload
    function updateStatus(siswa) {
      let statusArea = document.getElementById("statusArea");
      let uploadArea = document.getElementById("uploadArea");
      let previewArea = document.getElementById("previewArea");

      statusArea.innerHTML = "<b>Status:</b> " + siswa.status;

      if (siswa.foto) {
        previewArea.innerHTML = `<img src="${siswa.foto}" alt="Foto"><br>`;
        uploadArea.classList.add("hidden");
      } else {
        previewArea.innerHTML = "";
        uploadArea.classList.remove("hidden");
      }
    }

    // Upload foto ke Apps Script
    async function uploadFoto() {
      let file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Pilih foto dulu!");

      let reader = new FileReader();
      reader.onload = async function (e) {
        let base64 = e.target.result;
        let body = { nama: selectedNama, foto: base64 };

        try {
          let res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(body)
          });
          let json = await res.json();
          if (json.status === "success") {
            alert("✅ Upload berhasil!");
            // update data lokal biar langsung kelihatan
            let siswa = allData.find(s => s.nama === selectedNama);
            siswa.status = "Menunggu Verifikasi";
            siswa.foto = json.url;
            updateStatus(siswa);
          } else {
            alert("❌ Upload gagal: " + json.message);
          }
        } catch (err) {
          alert("❌ Error: " + err.message);
        }
      };
      reader.readAsDataURL(file);
    }

    // Jalankan pertama kali
    loadData();
  </script>
</body>
</html>
