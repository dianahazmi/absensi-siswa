<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi Siswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 600px; margin-top: 40px; }
    .student-card { padding: 20px; background: white; border-radius: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .thumbnail { max-width: 200px; border-radius: 10px; margin-top: 10px; }
  </style>
</head>
<body>
<div class="container">
  <h3 class="text-center mb-3">📷 Absensi Siswa</h3>

  <div id="statusKoneksi" class="alert alert-secondary py-2 text-center">
    🔄 Mengecek koneksi ke CSV publik...
  </div>

  <div class="input-group mb-3">
    <input class="form-control" list="namaList" id="namaInput" placeholder="Cari nama siswa...">
    <button class="btn btn-primary" onclick="cariNama()">Pilih</button>
  </div>
  <datalist id="namaList"></datalist>
  <div id="studentSection" class="student-card mt-4 d-none"></div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ34iHsZU_lS2ZEv2YVCbHRx1MdoJWg0y5rfJKQ_hiXgAGkoZwQlLHT78kvuZnT0e8beckdTjPBvkuR/pub?gid=0&single=true&output=csv";
let allStudents = [];
let currentStudent = null;

// Load CSV via fetch, parse, then populate list
fetch(CSV_URL)
  .then(res => {
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.text();
  })
  .then(csvText => {
    // Parse CSV to array
    const lines = csvText.trim().split("\n");
    const headers = lines.shift().split(",");
    allStudents = lines.map(line => {
      const values = line.split(",");
      return {
        nama: values[0],
        status: values[1] || "Belum Absen",
        foto: values[2] || ""
      };
    });

    const list = document.getElementById("namaList");
    allStudents.forEach(s => {
      let opt = document.createElement("option");
      opt.value = s.nama;
      list.appendChild(opt);
    });

    document.getElementById("statusKoneksi").className = "alert alert-success py-2 text-center";
    document.getElementById("statusKoneksi").innerText = "✅ Tersambung ke CSV publik (" + allStudents.length + " siswa)";
  })
  .catch(err => {
    document.getElementById("statusKoneksi").className = "alert alert-danger py-2 text-center";
    document.getElementById("statusKoneksi").innerText = "❌ Gagal memuat CSV: " + err;
  });

function cariNama() {
  const nama = document.getElementById("namaInput").value.trim();
  currentStudent = allStudents.find(s => s.nama.toLowerCase() === nama.toLowerCase());
  const section = document.getElementById("studentSection");
  section.classList.remove("d-none");

  if (!currentStudent) {
    section.innerHTML = `<p class="text-danger">Nama tidak ditemukan.</p>`;
    return;
  }

  let color = currentStudent.status.includes("Terverifikasi") ? "success" 
             : currentStudent.status.includes("Menunggu") ? "warning" 
             : "secondary";

  section.innerHTML = `
    <h5>${currentStudent.nama}</h5>
    <p>Status: <span class="badge bg-${color}">${currentStudent.status}</span></p>
  `;
  if (currentStudent.foto) {
    section.innerHTML += `
      <a href="${currentStudent.foto}" target="_blank">
        <img src="${currentStudent.foto}" class="thumbnail img-thumbnail">
      </a>`;
  } else {
    section.innerHTML += `<p><em>Belum ada foto.</em></p>`;
  }
}
</script>
</body>
</html>
